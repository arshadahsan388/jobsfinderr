<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TikTok Authorization Callback - JobsFindeRR</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .callback-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 3rem;
            max-width: 600px;
            width: 90%;
            text-align: center;
        }
        .tiktok-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(45deg, #ff0050, #ff4081);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 2rem;
            color: white;
            font-size: 2rem;
            font-weight: bold;
        }
        .code-display {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 1.5rem;
            margin: 2rem 0;
            font-family: 'Courier New', monospace;
            word-break: break-all;
        }
        .status-badge {
            display: inline-block;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            margin: 1rem 0;
            font-weight: 500;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .loading { background: #d1ecf1; color: #0c5460; }
        .btn-home {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            color: white;
            text-decoration: none;
            display: inline-block;
            margin-top: 2rem;
            transition: transform 0.3s ease;
        }
        .btn-home:hover {
            transform: translateY(-2px);
            color: white;
            text-decoration: none;
        }
    </style>
</head>
<body>
    <div class="callback-container">
        <div class="tiktok-icon">
            üéµ
        </div>
        
        <h2 class="mb-3">TikTok Shop Authorization</h2>
        <p class="text-muted mb-4">Processing your TikTok Shop integration...</p>
        
        <div id="status" class="status-badge loading">
            üîÑ Checking authorization code...
        </div>
        
        <div class="code-display">
            <strong>Authorization Code:</strong><br>
            <span id="code" class="text-primary">Loading...</span>
        </div>
        
        <div id="details" class="mt-4">
            <p><strong>State:</strong> <span id="state" class="text-secondary">-</span></p>
            <p><strong>Timestamp:</strong> <span id="timestamp" class="text-secondary">-</span></p>
        </div>
        
        <div id="next-steps" class="mt-4" style="display: none;">
            <div class="alert alert-info">
                <strong>‚úÖ Authorization Successful!</strong><br>
                Your TikTok Shop integration is now configured. You can close this window.
            </div>
        </div>
        
        <a href="{{ url_for('home') }}" class="btn-home">
            üè† Back to JobsFindeRR
        </a>
    </div>

    <script>
        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');
        const state = urlParams.get('state');
        const error = urlParams.get('error');
        const errorDescription = urlParams.get('error_description');
        
        // Display current timestamp
        document.getElementById('timestamp').textContent = new Date().toLocaleString();
        
        // Handle authorization response
        if (error) {
            // Handle error
            document.getElementById('status').className = 'status-badge error';
            document.getElementById('status').innerHTML = '‚ùå Authorization Failed';
            document.getElementById('code').textContent = `Error: ${error}`;
            if (errorDescription) {
                document.getElementById('code').textContent += `\nDescription: ${errorDescription}`;
            }
        } else if (code) {
            // Handle success
            document.getElementById('status').className = 'status-badge success';
            document.getElementById('status').innerHTML = '‚úÖ Authorization Code Received';
            document.getElementById('code').textContent = code;
            document.getElementById('state').textContent = state || 'Not provided';
            document.getElementById('next-steps').style.display = 'block';
            
            // Log the code for development purposes
            console.log('TikTok Authorization Code:', code);
            console.log('State:', state);
            
            // You can send this code to your backend for token exchange
            // Example: sendCodeToBackend(code, state);
            
        } else {
            // No code received
            document.getElementById('status').className = 'status-badge error';
            document.getElementById('status').innerHTML = '‚ö†Ô∏è No Authorization Code';
            document.getElementById('code').textContent = 'No authorization code found in URL parameters';
        }
        
        // Optional: Function to send code to backend
        function sendCodeToBackend(authCode, authState) {
            fetch('/api/tiktok/token', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    code: authCode,
                    state: authState
                })
            })
            .then(response => response.json())
            .then(data => {
                console.log('Token exchange result:', data);
            })
            .catch(error => {
                console.error('Token exchange error:', error);
            });
        }
        
        // Auto-refresh after 5 minutes for security
        setTimeout(() => {
            if (confirm('This page will refresh for security. Continue?')) {
                window.location.href = '{{ url_for("home") }}';
            }
        }, 300000); // 5 minutes
    </script>
</body>
</html>
