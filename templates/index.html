{% extends "base.html" %} {% block meta %}
  {% set meta_title = "Latest Government Jobs in Pakistan - July 2025" %}
  {% set meta_description = "Explore government jobs updated daily. Smart AI-powered job search for every city in Pakistan." %}
  {% set meta_keywords = "govt jobs, karachi jobs, lahore jobs, remote, AI jobs" %}
{% endblock %} {% block content %}


<!-- Beautiful Loading Animation -->
<div id="loader" class="loader" style="display: none;">
  <div class="loader-text">JobsFinderr</div>
  
  <div class="loader-dots">
    <div class="dot"></div>
    <div class="dot"></div>
    <div class="dot"></div>
    <div class="dot"></div>
    <div class="dot"></div>
  </div>
  
  <div class="loader-progress">
    <div class="loader-progress-bar"></div>
  </div>
  
  <div class="loader-message">Loading amazing jobs for you...</div>
</div>

<script>
// Immediately check if user is returning from detail page
(function() {
  const scrollPosition = localStorage.getItem('jobsScrollPosition');
  const isReturning = scrollPosition !== null;
  
  if (isReturning) {
    // User is returning - hide loader completely and restore position immediately
    const loader = document.getElementById("loader");
    if (loader) {
      loader.style.display = "none";
      loader.style.visibility = "hidden";
      loader.style.opacity = "0";
    }
    
    // Restore scroll position immediately
    setTimeout(() => {
      window.scrollTo(0, parseInt(scrollPosition));
      localStorage.removeItem('jobsScrollPosition');
    }, 50);
  } else {
    // First visit - show loader briefly
    const loader = document.getElementById("loader");
    if (loader) {
      loader.style.display = "flex";
      setTimeout(() => {
        loader.classList.add("hidden");
      }, 800);
    }
  }
})();
</script>

  <!-- Enhanced Search and Filter Section -->
  <div class="search-filter-container mb-4">
    <div class="container">
      <div class="row justify-content-center">
        <div class="col-lg-8">
          <div class="search-box-wrapper">
            <!-- Main Search Input -->
            <div class="search-input-container">
              <i class="search-icon">üîç</i>
              <input
                type="text"
                id="jobSearch"
                class="search-input"
                placeholder="Search for jobs, departments, or positions..."
                onkeyup="filterJobs()"
              />
              <button class="clear-search" id="clearSearch" onclick="clearSearch()" style="display: none;">
                <i>‚úñ</i>
              </button>
            </div>
            
            <!-- Filter Buttons and Sort Options -->
            <div class="filter-sort-row">
              <div class="filter-buttons">
                <button class="filter-btn active" onclick="filterByType('all')" data-filter="all">
                  <span class="filter-icon">üìã</span>
                  All Jobs
                  <span class="job-count" id="allCount">{{ jobs|length }}</span>
                </button>
                <button class="filter-btn" onclick="filterByType('government')" data-filter="government">
                  <span class="filter-icon">üèõÔ∏è</span>
                  Govt Jobs
                  <span class="job-count" id="govCount">0</span>
                </button>
                <button class="filter-btn" onclick="filterByType('private')" data-filter="private">
                  <span class="filter-icon">üè¢</span>
                  Private Jobs
                  <span class="job-count" id="privateCount">0</span>
                </button>
              </div>

              <!-- Sort Options on same line -->
              <div class="sort-options">
                <label for="sortSelect">Sort by:</label>
                <select id="sortSelect" class="sort-select" onchange="sortJobs()">
                  <option value="newest">Newest First</option>
                  <option value="oldest">Oldest First</option>
                  <option value="title">Job Title A-Z</option>
                  <option value="department">Department A-Z</option>
                  <option value="deadline">Application Deadline</option>
                </select>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Job Cards -->
  <div class="row row-cols-1 row-cols-md-3 g-4" id="jobContainer">
    {% for job in jobs %}
    <div class="col job-item" data-job-type="{{ job.details.get('Job Type', 'private').lower() }}" data-department="{{ job.details.get('Department', '') }}" data-deadline="{{ job.details.get('Last Date for Apply', '') }}" data-title="{{ job.title }}">
      <div class="card h-100 position-relative clickable-card" onclick="navigateToJob('{{ job.id }}')">
        <div class="card-body">
          <!-- Job Type Badge inside card body - Only show if Job Type exists -->
          {% if job.details.get('Job Type') %}
          <div class="job-type-badge-inline">
            {% if job.details.get('Job Type', '').lower() == 'government' %}
              <span class="badge-govt">üèõÔ∏è Government</span>
            {% elif job.details.get('Job Type', '').lower() == 'private' %}
              <span class="badge-private">üè¢ Private</span>
            {% endif %}
          </div>
          {% endif %}

          <h5 class="card-title title">{{ job.title }}</h5>
          {% if job.images and job.images[0] %}
          <img src="{{ job.images[0] }}" alt="Job Image" class="img-fluid rounded mb-3" />
          {% endif %}
          
          <div class="job-details">
            <p class="job-detail-item">
              <strong><i>üìÖ</i> Last Date:</strong>
              <span class="deadline-text">{{ job.details.get('Last Date for Apply', 'Not specified') }}</span>
            </p>

            <p class="job-detail-item">
              <strong><i>üéì</i> Education:</strong> 
              <span>{{ job.details.get('Education', 'Not specified') }}</span>
            </p>

            {% if job.details.get('Department') %}
            <p class="job-detail-item">
              <strong><i>üè¢</i> Department:</strong>
              <span class="department-text">{{ job.details.get('Department') }}</span>
            </p>
            {% endif %}
          </div>

          <a
            href="{{ url_for('job_detail', job_id=job.id) }}"
            class="btn btn-primary mt-3"
            onclick="event.stopPropagation(); saveScrollPosition();"
            >Apply Now <i>‚Üí</i></a
          >
          
          {% if job.get('is_new') and job.get('added_at') %}
          <div class="time-badge mt-2" data-timestamp="{{ job.get('added_at') }}">
            <span class="time-text">Just added</span>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
</div>
<div class="text-center my-4">
  <img src="{{ url_for('static', filename='banner.png') }}" alt="JobsFinderr Banner" class="img-fluid rounded shadow" />
</div>
<script>
  function toggleDarkMode() {
    document.body.classList.toggle("dark-mode");

    // Save theme preference
    if (document.body.classList.contains("dark-mode")) {
      localStorage.setItem("darkMode", "enabled");
    } else {
      localStorage.setItem("darkMode", "disabled");
    }
  }

  function filterJobs() {
    const input = document.getElementById("jobSearch").value.toLowerCase();
    const clearBtn = document.getElementById("clearSearch");
    const cards = document.querySelectorAll(".job-item");
    const activeFilter = document.querySelector(".filter-btn.active").getAttribute("data-filter");

    // Show/hide clear button
    clearBtn.style.display = input ? "block" : "none";

    let visibleCount = 0;
    cards.forEach((card) => {
      const title = card.querySelector(".title")?.textContent.toLowerCase() || "";
      const dept = card.querySelector(".department-text")?.textContent.toLowerCase() || "";
      const jobType = card.getAttribute("data-job-type");
      
      const matchesSearch = title.includes(input) || dept.includes(input);
      const matchesFilter = activeFilter === "all" || jobType === activeFilter;

      if (matchesSearch && matchesFilter) {
        card.style.display = "block";
        visibleCount++;
      } else {
        card.style.display = "none";
      }
    });

    updateJobCounts();
    showNoResultsMessage(visibleCount === 0);
  }

  function clearSearch() {
    document.getElementById("jobSearch").value = "";
    document.getElementById("clearSearch").style.display = "none";
    filterJobs();
  }

  function filterByType(type) {
    // Update active button
    document.querySelectorAll(".filter-btn").forEach(btn => btn.classList.remove("active"));
    document.querySelector(`[data-filter="${type}"]`).classList.add("active");
    
    filterJobs();
  }

  function sortJobs() {
    const sortBy = document.getElementById("sortSelect").value;
    const container = document.getElementById("jobContainer");
    const cards = Array.from(container.querySelectorAll(".job-item"));

    cards.sort((a, b) => {
      switch(sortBy) {
        case "title":
          return a.getAttribute("data-title").localeCompare(b.getAttribute("data-title"));
        case "department":
          const deptA = a.getAttribute("data-department") || "";
          const deptB = b.getAttribute("data-department") || "";
          return deptA.localeCompare(deptB);
        case "deadline":
          const deadlineA = a.getAttribute("data-deadline") || "";
          const deadlineB = b.getAttribute("data-deadline") || "";
          return deadlineA.localeCompare(deadlineB);
        case "oldest":
          return 0; // Keep original order for oldest
        case "newest":
        default:
          return 0; // Keep original order for newest (default)
      }
    });

    if (sortBy === "oldest") {
      cards.reverse();
    }

    // Re-append sorted cards
    cards.forEach(card => container.appendChild(card));
  }

  function updateJobCounts() {
    const allCards = document.querySelectorAll(".job-item");
    const govCards = document.querySelectorAll('.job-item[data-job-type="government"]');
    const privateCards = document.querySelectorAll('.job-item[data-job-type="private"]');
    
    const visibleAll = Array.from(allCards).filter(card => card.style.display !== "none").length;
    const visibleGov = Array.from(govCards).filter(card => card.style.display !== "none").length;
    const visiblePrivate = Array.from(privateCards).filter(card => card.style.display !== "none").length;

    document.getElementById("allCount").textContent = visibleAll;
    document.getElementById("govCount").textContent = visibleGov;
    document.getElementById("privateCount").textContent = visiblePrivate;
  }

  function showNoResultsMessage(show) {
    let noResultsMsg = document.getElementById("noResultsMessage");
    
    if (show && !noResultsMsg) {
      noResultsMsg = document.createElement("div");
      noResultsMsg.id = "noResultsMessage";
      noResultsMsg.className = "no-results-message";
      noResultsMsg.innerHTML = `
        <div class="text-center py-5">
          <div class="no-results-icon">üîç</div>
          <h4>No jobs found</h4>
          <p>Try adjusting your search or filter criteria</p>
          <button class="btn btn-outline-primary" onclick="clearSearch(); filterByType('all');">
            Show All Jobs
          </button>
        </div>
      `;
      document.getElementById("jobContainer").appendChild(noResultsMsg);
    } else if (!show && noResultsMsg) {
      noResultsMsg.remove();
    }
  }

  function hideLoader() {
    const loader = document.getElementById("loader");
    
    // Instant hide - no delay
    loader.classList.add("hidden");
  }

  // Save scroll position when clicking on job
  function saveScrollPosition() {
    localStorage.setItem('jobsScrollPosition', window.scrollY);
  }

  // Navigate to job detail when card is clicked
  function navigateToJob(jobId) {
    saveScrollPosition();
    window.location.href = `/job/${jobId}`;
  }

  // Calculate time ago from timestamp
  function timeAgo(timestamp) {
    const now = new Date();
    const jobTime = new Date(timestamp);
    const diffMs = now - jobTime;
    const diffMinutes = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMinutes / 60);
    const diffDays = Math.floor(diffHours / 24);

    if (diffMinutes < 1) return "Just now";
    if (diffMinutes < 60) return `${diffMinutes} min ago`;
    if (diffHours < 24) return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
    if (diffDays < 7) return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
    return "Recently added";
  }

  // Update time badges
  function updateTimeBadges() {
    const timeBadges = document.querySelectorAll('.time-badge');
    timeBadges.forEach(badge => {
      const timestamp = badge.getAttribute('data-timestamp');
      if (timestamp) {
        const timeText = badge.querySelector('.time-text');
        if (timeText) {
          timeText.textContent = timeAgo(timestamp);
        }
      }
    });
  }

  // Restore scroll position when returning from job detail
  function restoreScrollPosition() {
    // Check if there's a scroll position in localStorage
    const scrollPosition = localStorage.getItem('jobsScrollPosition');
    if (scrollPosition) {
      setTimeout(() => {
        window.scrollTo(0, parseInt(scrollPosition));
        localStorage.removeItem('jobsScrollPosition'); // Remove after use
      }, 100); // Small delay to ensure page is fully loaded
    }
  }

  // Apply saved theme on load
  window.addEventListener("load", function () {
  const isDark = localStorage.getItem("darkMode") === "enabled";
  if (isDark) {
    document.body.classList.add("dark-mode");
  } else {
    document.body.classList.remove("dark-mode");
  }

  // Check if user is returning from job detail page
  const scrollPosition = localStorage.getItem('jobsScrollPosition');
  if (scrollPosition) {
    // User is returning - no animation, just restore position
    const loader = document.getElementById("loader");
    if (loader) {
      loader.style.display = "none";
    }
  } else {
    // First time visit - handle loader normally
    setTimeout(() => {
      hideLoader();
    }, 800);
  }
  
  // Update time badges on load
  updateTimeBadges();
  
  // Update time badges every minute
  setInterval(updateTimeBadges, 60000);
  
  // Initialize job counts
  updateJobCounts();
});

</script>

{% endblock %}
